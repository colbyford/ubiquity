---
title: 'Naive-Pooled Parameter Estimation in Ubiquity'
author: "John Harrold <john.m.harrold@gmail.com>"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Estimation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(ubiquity)
require(deSolve)
require(ggplot2)
require(foreach)
require(doParallel)
require(doRNG)
require(rhandsontable)
```

## Introduction
The workshop (http://workshop.ubiquity.grok.tv) has several examples in the folder:
``workshop/r_examples/estimation_example/`` with the following scripts:

* ``analysis_parent.r`` - Least squares estimation of a single output
* ``analysis_parent_metabolite.r`` - Maximum likelihood estimation of two outputs
* ``analysis_parent_metabolite_global.r`` - Using global optimization toolboxes
* ``analysis_parent_metabolite_nm_data.r`` - Reading cohorts in from a NONMEM file
 
Each of these scripts build on the previous one to demonstrate different features of the ubiquity parameter estimation routines. All of these examples use a system (shown in the figure below) that contains three differential equations tracking the mass of the parent drug in the blood (``Mpb``) and in a tissue space (``Mpt``). In the blood the parent can form the metabolite (``Mmb``) can form (``fmKp``) and will be eliminated (``Km``). The parent/metabolite model was adapted from the ADAPT5 Users Manual (https://bmsr.usc.edu/files/2013/02/ADAPT5-User-Guide.pdf). 

![Model structure of parent/metabolite model](system-estimation_example.png){width=100%}

Using ``system_new`` you can copy this template file into the current directory and build the system:

```{r results="hide", message=FALSE}
library(ubiquity)
system_new(file_name="system.txt", system_file="adapt", overwrite = TRUE)
cfg = build_system(system_file = "system.txt")
```

Once the system has been built, you can create a local copy of an estimation template for the system:

```{r results="hide"}
system_fetch_template(cfg, template="Estimation")
```

This should create the file: ``analysis_estimate.R`` in the working directory. The variable ``analysis_name`` defines the prefix that will be prepended to the output generated by the script[^1]. Archiving the analysis results is controlled by the Boolean variable ``archive_results``. Lastly, the script is controlled using the ``flowctl`` variable (the possible options are listed and commented out).

The analysis script has the following main components:

1. Select parameters to estimate
2. Set options (simulation, estimation, etc)
3. Load data sets
4. Define cohorts
5. Estimate parameters
6. Plot results

## ``analysis_parent.r``

In the first example above (``analysis_parent.r``) we begin by specifying  that we want to perform a parameter estimation, archive the results using the name ``parent_d1030``:

```{r results="hide", echo=FALSE}
flowctl = 'estimate'
archive_results = TRUE
analysis_name = 'parent_d1030'
```

Next we select the parameters to estimate. Because we're only estimating parent data, we only select the names of the parameters relevant to the parent PK (``pnames``).

```{r results="hide", echo=TRUE}
pnames = c('Vp', 'Vt', 'CLp', 'Q')
cfg = system_select_set(cfg, "default", pnames)
```

Next we set options relevant to the simulation or estimation. Here we only define the simulation output times, but any relevant parameters can be set. The template that is generated has several common options that are commented out. These can be uncommitted and modified as needed.

```{r results="hide", echo=TRUE}
cfg=system_set_option(cfg, group  = "simulation", 
                           option = "output_times", 
                           seq(0,100,1))
```

The data set (shown in the table below) is included with the ``ubiquity`` package and is accessed here using ``system.file``. In the example script it is referenced explicitly. The format requirements of data sets is that they be flat files with a header row. The format is flexible and only requires time/observation information and columns required to filter the data and isolate cohorts that have received the same treatment. The inputs are defined when the cohorts themselves are defined. These files are loaded using ``system_load_dataset`` and a name[^2] is assigned the data set. This name (``pm_data``) will be used to reference this data set later in the script.

```{r results="hide", echo=TRUE, warning=FALSE}
cfg = system_load_data(cfg, dsname     = "pm_data", 
                            data_file  = system.file("extdata", 
                                                     "pm_data.csv", 
                                                     package = "ubiquity"))
```


```{r results="hide", echo=FALSE}
dataset = read.csv(system.file("extdata", "pm_data.csv", package = "ubiquity"))
```
```{r echo=FALSE, fig.align="center"}
rhandsontable(dataset, width=400, height=200)
```

The data set has a column for the observation time (``TIME``), the subject id (``ID``), concentrations for the parent (``PT``) and metabolite (``MT``), a ``BLQ`` flag and the nominal dose (``DOSE``). This is intended to be an example and not a general guide for a data set format. For example it is not necessary to have different outputs in different columns. In this example we are going to analyze the parent data for individuals give 10 or 30 mg using a least squares estimation.

Next we need to identify the data and inputs associated with that data. This is done by defining *cohorts*, groups of data that receive the same treatment and the inputs (bolus dosing, infusion rates, covariates) associated with those cohorts. In this example we will define a cohort for each dosing group. To make sure we are starting from a blank slate we can use ``system_clear_cohorts`` to remove any previously defined information.
```{r results="hide", echo=TRUE, warning=FALSE}
cfg = system_clear_cohorts(cfg)
```


For each cohort we define a list with information about that cohort. Each cohort should have a unique ``name`` field [^3] and a ``dataset`` field pointing to the data set (``pm_data``) loaded above. The optional  cohort filter (``cf``) field is used to reduce the entire data set to the records associated with this cohort. See the manual for ``system_define_cohort`` for more information on how to construct cohort filters.

```{r results="hide", echo=TRUE, warning=FALSE}
cohort  = c()
cohort$name                                   = 'dose_10'
cohort$dataset                                = 'pm_data'
cohort$cf$DOSE                                = c(10)
```

Next it is necessary to define the inputs for this cohort. Here inputs refers to both dosing as well as covariates, and the template should contain placeholders for each of these defined in the system file. Note: For bolus and infusion inputs, it is only necessary to define inputs that are nonzero, and for covariates it is only necessary to define those that differ from the definitions in the system file. For each input there is an ``AMT`` field and ``TIME`` field and the units here are those specified in the system file.

```{r results="hide", echo=TRUE, warning=FALSE}
cohort$inputs$bolus$Mpb$AMT                   = c(10)
cohort$inputs$bolus$Mpb$TIME                  = c(0)
```

Next we need to match the outputs in the model to the outputs in the data set.
Under ``cohort$outputs`` there is a field for each output. Here *output name* of
the blood PK of the parent output is ``Parent``. The times and observations in
the data set are found in the ``'TIME’`` column and the ``’PT’`` column (missing
data specified by -1 will be dropped). These are mapped to the model outputs
(which MUST have the same units) ``’hours’`` and ``’Cpblood’``:

```{r results="hide", echo=TRUE, warning=FALSE}
cohort$outputs$Parent$obs$time                = 'TIME'
cohort$outputs$Parent$obs$value               = 'PT'
cohort$outputs$Parent$obs$missing             = -1
cohort$outputs$Parent$model$time              = 'hours'
cohort$outputs$Parent$model$value             = 'Cpblood'
cohort$outputs$Parent$model$variance          = '1'
```

For each output in the cohort the marker color, shape and line type can be specified (controlling the plotted output).

```{r results="hide", echo=TRUE, warning=FALSE}
cohort$outputs$Parent$options$marker_color    = 'black'   
cohort$outputs$Parent$options$marker_shape    = 1
cohort$outputs$Parent$options$marker_line     = 2
```

Finally the cohort is defined using ``system_define_cohort``:

```{r results="hide", echo=TRUE, warning=FALSE}
cfg = system_define_cohort(cfg, cohort)
```

We do the same thing for the 30 mg dose group:

```{r results="hide", echo=TRUE, warning=FALSE}
cohort  = c()
cohort$name                                   = 'dose_30'
cohort$dataset                                = 'pm_data'
cohort$cf$DOSE                                = c(30)
cohort$inputs$bolus$Mpb$AMT                   = c(30)
cohort$inputs$bolus$Mpb$TIME                  = c(0)
cohort$outputs$Parent$obs$time                = 'TIME'
cohort$outputs$Parent$obs$value               = 'PT'
cohort$outputs$Parent$obs$missing             = -1
cohort$outputs$Parent$model$time              = 'hours'
cohort$outputs$Parent$model$value             = 'Cpblood'
cohort$outputs$Parent$model$variance          = '1'
cohort$outputs$Parent$options$marker_color    = 'red'   
cohort$outputs$Parent$options$marker_shape    = 2
cohort$outputs$Parent$options$marker_line     = 2

cfg = system_define_cohort(cfg, cohort)

```

After the cohorts have been defined we call the estimation function (``system_estimate_parameters``). If ``flowctl`` is set to  ``'plot previous estimate'`` or ``'plot guess'`` the those values will just be returned. 
```{r results="hide", echo=TRUE, warning=FALSE}
pest = system_estimate_parameters(cfg, 
                                  flowctl         = flowctl, 
                                  analysis_name   = analysis_name, 
                                  archive_results = archive_results)
```


If one of the estimation options are selected for the ``flowctl`` then several files will be generated in the ``output`` folder with the ``analysis_name`` as a prefix:

* ``output/parent_d1030-report.txt`` - Text file with a summary of the estimation results. 
* `` output/parent_d1030-parameters_all.csv`` - Summary table with all parameters (estimated and fixed)
* `` output/parent_d1030-parameters_est.csv`` - Summary table with estimated parameters 

Next the system is simulated at the estimate and the data is stored in ``erp``. 

```{r results="hide", echo=TRUE, warning=FALSE}
erp = system_simulate_estimation_results(pest = pest, cfg = cfg) 

```

The information in this variable will be used to generate some standard plots below, but it may be desirable to save this information or generate your own figures. To do this it is necessary to understand the structure of ``erp``. This list has two different fields.

* ``erp$pred`` List providing observations and predictions at the sample times as well as smooth predictions profiles at the specified simulation times.  
     + ``TIME`` - Time in units of the data
     + ``OBS`` - Observations (``SMOOTH = FALSE``), -1 (``SMOOTH=TRUE``)
     + ``PRED`` - Predictions (``SMOOTH = FALSE``)
     + ``VAR`` - Variance (SMOOTH = FALSE), -1 (SMOOTH=TRUE)
     + ``SMOOTH`` - ``FALSE`` for observation times, ``TRUE`` for observations
     + ``OUTPUT`` - name of the output
     + ``COHORT`` - name of the cohort
* ``erp$all`` List with model predictions for each output and state are generated for each cohort at the specified simulation times. 
     +  ``ts.time`` - Simulation time scale
     +  ``ts.T`` - An entry for each timescale ``TS``
     +  ``pred`` - Simulated predictions
     +  ``name`` - State or model output
     +  ``cohort`` - Cohort name

Lastly the predictions overlaying the data and the observed vs predicted plots are generated using ``system_plot_cohorts``. Basic formatting of these figures is controlled using the ``plot_opts`` list (see the ``?system_plot_cohorts`` for details . 

```{r results="hide", echo=TRUE, warning=FALSE, fig.align="center", fig.width=2}
plot_opts = c()
plot_opts$outputs$Parent$yscale       = 'log'
plot_opts$outputs$Metabolite$yscale   = 'linear'
```
 
```{r results="hide", echo=TRUE, warning=FALSE, eval=TRUE}
plinfo = system_plot_cohorts(erp, plot_opts, cfg, prefix=analysis_name)
```

When called, ``system_plot_cohorts`` will write ``png`` and ``pdf`` output for the time course and observed vs predicted files. It will also return a list with the ``ggplot`` objects and relative paths to the files as well. In this example the following will be generated:

* output/parent_d1030_time course_Parent.pdf 
* output/parent_d1030_time course_Parent.png 
* output/parent_d1030_obs_pred_Parent.pdf 
* output/parent_d1030_obs_pred_Parent.png 

```{r fig.width=7, fig.height=4, echo=FALSE}
plinfo$timecourse$Parent
```

```{r fig.width=7, fig.height=4, echo=FALSE}
plinfo$obs_pred$Parent
```

##``analysis_parent_metabolite.r`` 

This example is similar to the last except we are analyzing two different outputs (parent and metabolite) and we have a proportional variance model. So now we can estimate the parameters associated with those outputs as well as the variance parameters:

```{r results="hide", echo=TRUE}
pnames = c('Vp',
           'Vt',
           'Vm',
           'CLp',
           'Q',
           'CLm',
           'slope_parent',
           'slope_metabolite');

cfg = system_select_set(cfg, "default", pnames)
```


The cohort definitions look much the same as those before except the variance model here is defined as  ``'slope_parent*PRED^2'``, and there is a separate output named ``Metabolite``.
```{r results="hide", echo=TRUE}
cfg = system_clear_cohorts(cfg)
cohort = c()
cohort$name                                      = 'dose_10'
cohort$cf$DOSE                                   = c(10)
cohort$dataset                                   = 'pm_data'
                                                 
cohort$inputs$bolus$Mpb$TIME                     = c(0)  # hours 
cohort$inputs$bolus$Mpb$AMT                      = c(10) # mpk 

cohort$outputs$Parent$obs$time                   = 'TIME' 
cohort$outputs$Parent$obs$value                  = 'PT'    
cohort$outputs$Parent$obs$missing                = -1;
cohort$outputs$Parent$model$time                 = 'hours'        
cohort$outputs$Parent$model$value                = 'Cpblood'
cohort$outputs$Parent$model$variance             = 'slope_parent*PRED^2'
cohort$outputs$Parent$options$marker_color       = 'black'
cohort$outputs$Parent$options$marker_shape       = 1
cohort$outputs$Parent$options$marker_line        = 1 

cohort$outputs$Metabolite$obs$time               = 'TIME' 
cohort$outputs$Metabolite$obs$value              = 'MT'    
cohort$outputs$Metabolite$obs$missing            = -1;
cohort$outputs$Metabolite$model$time             = 'hours'        
cohort$outputs$Metabolite$model$value            = 'Cmblood'
cohort$outputs$Metabolite$model$variance         = 'slope_metabolite*PRED^2'
cohort$outputs$Metabolite$options$marker_color   = 'blue'
cohort$outputs$Metabolite$options$marker_shape   = 1
cohort$outputs$Metabolite$options$marker_line    = 1 
cfg = system_define_cohort(cfg, cohort)
```

Similar modifications were made to the 30 mg dosing cohort.

##``analysis_parent_metabolite_global.r`` 

Now we build on the previous example to demonstrate how to select different optimization routines. By default, the parameter estimation is carried out using the ``Nelder-Mead`` optimization method in the ``optim`` library is used. You can specify different functions in the library. See the documentation for optim (?optim) for valid values for method and elements for the control.  For example, to use simulated annealing change the "method" to SANN.

```{r eval=FALSE}
cfg = system_set_option(cfg, group  = "estimation",
                             option = "method",
                             value  = "SANN")
```

There are also global optimization libraries in R, and two of these can be readily used with ubiquity: Particle Swarm Optimizer (``pso`` package) and Genetic Algorithms (``GA`` package).


To use the ``pso`` package set the following options:
```{r eval=FALSE}
library("pso")
cfg = system_set_option(cfg, group  = "estimation",
                             option = "optimizer", 
                             value  = "pso")

cfg = system_set_option(cfg, group  = "estimation",
                             option = "method",
                             value  = "psoptim")
```

To use the ``GA`` package set the following options:
```{r eval=FALSE}
library(GA)

cfg = system_set_option(cfg, group  = "estimation",
                             option = "optimizer", 
                             value  = "ga")

cfg = system_set_option(cfg, group  = "estimation",
                             option = "method",
                             value  = "ga")

cfg = system_set_option(cfg, group  = "estimation",
                             option = "control", 
                             value  = list(maxiter   = 10000, 
                                           optimArgs = list(method  = "Nelder-Mead",
                                                            maxiter = 1000)))
```


##``analysis_parent_metabolite_nm_data.r`` 

In the examples above, cohorts are defined manually. Sometimes you may have data in a NONMEM data set where the dosing information is located in the data set. It may be convenient to simply define a cohort for each subject in the data set. To do that the function ``system_define_cohorts_nm`` can be used. The differences between the script ``analysis_parent_metabolite.r`` will now be highlighted:

First we load the NONMEM data set and clear the cohorts:
```{r eval=FALSE}
cfg = system_load_data(cfg, dsname     = "nm_pm_data", 
                            data_file  = system.file("extdata", 
                                                     "nm_data.csv", 
                                                     package = "ubiquity"))
cfg = system_clear_cohorts(cfg);
```


 


Next we define a filter to use on the data set (include only the 10 and 30 mg doses):
```{r eval=FALSE}
filter = list()
filter$DOSE = c(10, 30)
```
For more information on filtering data sets see the help for ``nm_select_records``.

Now we define maps for the different outputs. For each output we specify the variance, compartment (``CMT``) number, model output and the missing number flag:
# Mapping information: 
```{r eval=FALSE}
OBSMAP = list()
OBSMAP$PT = list(variance     = 'slope_parent*PRED^2',
                 CMT          =  1,
                 output       = 'Cpblood', 
                 missing      =  -1 )

OBSMAP$MT = list(variance     = 'slope_metabolite*PRED^2',
                 CMT          =  2,
                 output       = 'Cmblood', 
                 missing      =  -1 )
```

Lastly we define a map for the model inputs. In this case we only have a bolus in the ``Mpb`` compartment:
```{r eval=FALSE}
INPUTMAP = list()
INPUTMAP$bolus$Mpb$CMT_NUM             =  1
```

With the filter, input and observation maps defined, we now add the cohorts
```{r eval=FALSE}
cfg = system_define_cohorts_nm(cfg, 
                               DS       = 'nm_pm_data',
                               col_ID   = 'ID',   col_CMT  = 'CMT', col_DV   = 'DV',
                               col_TIME = 'TIME', col_AMT  = 'AMT', col_RATE = 'RATE',
                               col_EVID = 'EVID', col_GROUP= 'DOSE',
                               filter   =  filter, 
                               INPUTS   =  INPUTMAP,
                               OBS      =  OBSMAP,
                               group    =  FALSE)
```
                                

## Contents of ``system.txt``
```{r echo=FALSE, comment=''}
cat(readLines("system.txt"), sep = "\n")
```
 
[^1]: analysis names must start with a letter and containing only letters, numbers, and _
[^2]: data set names must start with a letter and containing only letters, numbers, and _
[^3]: cohort names must start with a letter and containing only letters, numbers, and _